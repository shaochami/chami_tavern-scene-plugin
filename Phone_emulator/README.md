# 手机模拟器功能说明

## 功能概述

手机模拟器是一个模拟社交软件聊天界面的功能模块，允许用户与AI角色进行逼真的对话交互。

## 文件结构

```
Phone_emulator/
├── css/
│   └── phone-emulator.css    # 手机模拟器样式文件
├── ui/
│   └── (预留，用于后续扩展)
├── js/
│   └── phone-emulator.js      # 手机模拟器主模块
├── db/
│   ├── chat-storage.js        # IndexedDB聊天记录存储
│   └── server-storage.js     # 服务器数据存储管理
├── api/
│   ├── ai-request.js         # AI请求模块（使用占位符）
│   └── content-filter.js      # 内容筛选和格式化
└── index.js                  # 入口文件
```

## 主要功能

### 1. 手机悬浮球
- 在设置面板的"检测到图像标签时自动生成"下方增加"手机模拟器"开关
- 开启后显示手机悬浮球按钮
- 点击悬浮球打开手机模拟器界面

### 2. 手机主界面
- 仿真的手机界面设计
- 包含消息、论坛、朋友圈、设置等应用图标
- 论坛和朋友圈功能预留，显示"开发中"

### 3. 消息列表（微信布局）
- 显示当前角色卡的所有联系人
- 显示最后一条消息预览和时间
- 点击进入详细聊天界面
- 支持新朋友添加功能

### 4. 聊天详情界面
- 左右对话气泡布局
- 用户消息在右侧，角色消息在左侧
- 附带头像显示
- 支持发送消息和接收AI回复

### 5. 新朋友添加
- 可以为角色上传头像
- 支持命名角色
- 头像上传到服务器，确保唯一性

### 6. API配置
- 配置聊天接口地址
- 配置API密钥
- 配置模型名称
- 配置保存到服务器

### 7. 数据存储
- 聊天记录保存到 `/user/files/tsp-chat-{角色卡名}.json`
- 使用IndexedDB进行本地缓存
- 角色卡切换时自动加载对应聊天记录
- 头像保存到服务器 `/user/images/tsp-phone-avatars/`

### 8. AI请求
- 使用占位符结构，方便后续修改
- 参考ai-processor.js的_getAutoModeChatInsertionMessages()方法
- 支持自定义请求结构

### 9. 内容筛选
- 筛选AI返回的内容，只保留带姓名与引号的内容
- 格式：角色："对话内容"
- 自动将长消息分割为多条短消息
- 确保对话简短自然

## 使用方法

1. **启用手机模拟器**
   - 打开插件设置
   - 找到"手机模拟器"开关
   - 开启后显示手机悬浮球

2. **配置API**
   - 打开手机模拟器
   - 进入"设置" > "API 配置"
   - 填写API地址、密钥和模型名称
   - 点击保存

3. **添加联系人**
   - 打开手机模拟器
   - 进入"消息" > "新朋友"
   - 上传头像（可选）
   - 输入角色名称
   - 点击添加

4. **开始聊天**
   - 在消息列表中点击联系人
   - 输入消息并发送
   - 等待AI回复

## 技术特点

1. **数据隔离**
   - 每个角色卡的聊天记录独立存储
   - 切换角色卡时自动加载对应记录
   - 不会加载其他角色卡的聊天记录

2. **性能优化**
   - 使用IndexedDB进行本地缓存
   - 按需加载聊天记录
   - 避免一次性加载所有数据

3. **服务器同步**
   - 聊天记录自动保存到服务器
   - 支持跨设备同步
   - 头像上传到服务器

4. **扩展性**
   - 清晰的文件夹结构
   - 模块化设计
   - 预留论坛、朋友圈等功能接口

## 后续扩展

可以在以下位置添加新功能：

1. **论坛功能**
   - 在Phone_emulator/js/phone-emulator.js的_openApp方法中添加forum逻辑
   - 创建对应的UI组件

2. **朋友圈功能**
   - 在Phone_emulator/js/phone-emulator.js的_openApp方法中添加moments逻辑
   - 创建对应的UI组件

3. **更多社交功能**
   - 可以参考现有的消息列表和聊天详情界面
   - 在Phone_emulator/css/phone-emulator.css中添加样式

## 注意事项

1. 确保API配置正确才能正常使用聊天功能
2. 头像上传需要服务器支持
3. 聊天记录保存在服务器，注意隐私保护
4. 切换角色卡时会自动加载对应聊天记录
